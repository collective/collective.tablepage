<form tal:omit-tag="not:view/edit_mode"
      id="tableForm"
      action=""
      method="post"
      tal:define="rows view/rows;"
      tal:attributes="action string:${context/absolute_url}/@@delete-record">

<table i18n:domain="collective.tablepage"
       class="listing tablePage"
       tal:define="portal_url view/portal_url;
                   headers view/headers;
                   has_tablemanager_permission view/check_tablemanager_permission;
				   can_add_label view/check_labeling_permission;
                   cssClasses python:' '.join(context.getCssClasses());"
       tal:attributes="class python: cssClasses and cssClasses + ' tablePage' or 'tablePage'"
       tal:condition="python: view.edit_mode or len(rows)>0">
        <caption tal:condition="context/getTableCaption"
                 tal:content="context/getTableCaption">This table is for...</caption>
    <thead tal:condition="view/showHeaders">
        <tr>
            <th class="nosort" tal:condition="python: view.edit_mode and rows">
                <input type="checkbox" id="selectAll" title="Select/unselect all"
                       i18n:attributes="title">
            </th>
            <th tal:repeat="header headers" scope="col" class="nosort">
                <span tal:replace="header/label">Header 1</span>
                <div class="discreet" tal:content="header/description">This is for...</div>
            </th>
            <th class="nosort rowCommands" tal:condition="view/edit_mode">&nbsp;</th>
        </tr>
    </thead>

    <tfoot class="visualNoPrint" tal:condition="python: view.edit_mode or context.getDownloadEnabled()">
        <tr class="rowCommands"><td tal:attributes="colspan python:len(headers)+2">
            <tal:canedit condition="python: view.edit_mode and context.getPageColumns()">
                <a class="command" href="" title="Add new label above"
				   tal:condition="can_add_label"
                   i18n:attributes="title"
                   tal:attributes="href string:${context/absolute_url}/@@edit-label">
                    <img alt="Add new label above that row" src=""
                         i18n:attributes="alt"
                         tal:attributes="src string:${view/portal_url}/++resource++collective.tablepage.images/labeling.png" />
                </a>
                <a id="massDelete" class="command" href="" title="Delete selected rows"
                   i18n:attributes="title"
                   href="">
                    <img alt="Delete rows" src=""
                         i18n:attributes="alt"
                         tal:attributes="src string:${view/portal_url}/++resource++collective.tablepage.images/remove.png" />
                </a>
                <a class="command" href="" title="Upload data with CSV"
                   i18n:attributes="title"
                   tal:attributes="href string:${context/absolute_url}/@@upload-rows">
                    <img alt="Upload data with CSV" src=""
                         i18n:attributes="alt"
                         tal:attributes="src string:${view/portal_url}/++resource++collective.tablepage.images/upload_data.png" />
                </a>
            </tal:canedit>
            <tal:download_enabled tal:condition="rows">
                <a class="command" href="" title="Download data in CSV format"
                   tal:define="target_mode python:view.edit_mode and '?target=editor' or ''"
                   i18n:attributes="title"
                   tal:attributes="href string:${context/absolute_url}/@@download-table${target_mode}">
                    <img alt="Download data in CSV format" src=""
                         tal:attributes="src string:${view/portal_url}/++resource++collective.tablepage.images/download_data.png"
                         i18n:attributes="alt"/>
                    <span class="discreet"
                          tal:condition="not:view/edit_mode"
                          i18n:translate="">Download as CSV</span>
                </a>            
            </tal:download_enabled>
        </td></tr>
    </tfoot>

    <tbody>
        <tal:rows repeat="row rows">
        <tr tal:define="even repeat/row/even;
                        row_index repeat/row/index;
						next_is_label python:view.next_is_label(row_index);
						is_data_row python:not view.is_label(row_index)"
            tal:attributes="class python:even and 'odd' or 'even'">
            <td tal:condition="python:view.edit_mode and is_data_row">
                <input class="selectRow" type="checkbox" name="row-index:int:list" value=""
                       tal:condition="python:has_tablemanager_permission or view.mine_row(row_index)"
                       tal:attributes="value repeat/row/index" />
            </td>
            <td tal:condition="is_data_row"
			    tal:repeat="cell row">
                <span tal:replace="structure cell" />
            </td>
			<td tal:condition="not:is_data_row"
			    scope="col" class="tablePageSubHeader" colspan=""
				tal:attributes="colspan python:len(headers) + (view.edit_mode and 1 or 0)"
				tal:content="row">
				Section header
			</td>
            <td class="rowCommands"
                tal:condition="view/edit_mode">
                <a class="command" href="" title="Add new row below this"
                   i18n:attributes="title"
				   tal:condition="python: next_is_label and repeat['row'].end"
                   tal:attributes="href string:${context/absolute_url}/@@edit-record">
                    <img alt="Add new row below" src=""
                         i18n:attributes="alt"
                         tal:attributes="src string:${view/portal_url}/++resource++collective.tablepage.images/add.png" />
                </a>
                <a class="command" href="" title="Add new row below this"
                   i18n:attributes="title"
				   tal:condition="python: next_is_label and not repeat['row'].end"
                   tal:attributes="href string:${context/absolute_url}/@@edit-record?row-index:int=${repeat/row/index}&addRow=1">
                    <img alt="Add new row" src=""
                         i18n:attributes="alt"
                         tal:attributes="src string:${view/portal_url}/++resource++collective.tablepage.images/add.png" />
                </a>
                <tal:mine-or-editor condition="python: has_tablemanager_permission or view.mine_row(row_index)">
                    <a class="command" href="" title="Edit row"
					   tal:condition="is_data_row"
                       i18n:attributes="title"
                       tal:attributes="href string:${context/absolute_url}/@@edit-record?row-index:int=${repeat/row/index}">
                        <img alt="Edit row" src=""
                             i18n:attributes="alt"
                             tal:attributes="src string:${portal_url}/++resource++collective.tablepage.images/edit.png" />
                    </a>
                    <a class="command" href="" title="Edit label"
					   tal:condition="not:is_data_row"					
                       i18n:attributes="title"
                       tal:attributes="href string:${context/absolute_url}/@@edit-label?row-index:int=${repeat/row/index}">
                        <img alt="Edit label" src=""
                             i18n:attributes="alt"
                             tal:attributes="src string:${portal_url}/++resource++collective.tablepage.images/edit.png" />
                    </a>
	                <a class="command" href="" title="Add new label above"
					   tal:condition="can_add_label"
	                   i18n:attributes="title"
	                   tal:attributes="href string:${context/absolute_url}/@@edit-label?row-index:int=${repeat/row/index}&addLabel=1">
	                    <img alt="Add new label above that row" src=""
	                         i18n:attributes="alt"
	                         tal:attributes="src string:${view/portal_url}/++resource++collective.tablepage.images/labeling.png" />
	                </a>
                    <a class="command" href="" title="Remove row"
                       i18n:attributes="title"
                       tal:attributes="href string:${context/absolute_url}/@@delete-record?row-index:int=${repeat/row/index}">
                        <img alt="Remove row" src=""
                             i18n:attributes="alt"
                             tal:attributes="src string:${portal_url}/++resource++collective.tablepage.images/remove.png" />
                    </a>
                </tal:mine-or-editor>
                <tal:manager-or-mine condition="has_tablemanager_permission">
                    <a class="command" href="" title="Move row up"
                       i18n:attributes="title"
                       tal:condition="not:repeat/row/start"
                       tal:attributes="href string:${context/absolute_url}/@@move-record?row-index:int=${row_index}&amp;direction=up">
                        <img alt="Move row up" src=""
                             i18n:attributes="alt"
                             tal:attributes="src string:${portal_url}/++resource++collective.tablepage.images/move_up.png" />
                    </a>
                    <a class="command" href="" title="Move row down"
                       i18n:attributes="title"
                       tal:condition="not:repeat/row/end"
                       tal:attributes="href string:${context/absolute_url}/@@move-record?row-index:int=${row_index}&amp;direction=down">
                        <img alt="Move row down" src=""
                             i18n:attributes="alt"
                             tal:attributes="src string:${portal_url}/++resource++collective.tablepage.images/move_down.png" />
                    </a>
                </tal:manager-or-mine>
            </td>
        </tr>
        </tal:rows>
        <tr class="noResults" tal:condition="not: rows">
            <td tal:attributes="colspan python:len(headers)"
                i18n:translate="">
                No rows
            </td>
			<td class="rowCommands"
			    tal:condition="python: view.edit_mode and context.getPageColumns()">
            <a class="command" href="" title="Add new row"
               i18n:attributes="title"
               tal:attributes="href string:${context/absolute_url}/@@edit-record">
                <img alt="Add new row" src=""
                     i18n:attributes="alt"
                     tal:attributes="src string:${view/portal_url}/++resource++collective.tablepage.images/add.png" />
            </a>

			</td>
        </tr>
    </tbody>
</table>

</form>